import { useState, useEffect } from 'react'
import { useNavigate } from '@tanstack/react-router'
import { Sparkles, ArrowRight, CheckCircle2, SkipForward, Bot, User, Smile, Settings, Zap } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Card, CardContent } from '@/components/ui/card'
import { Progress } from '@/components/ui/progress'
import { Input } from '@/components/ui/input'
import { Label } from '@/components/ui/label'
import { Textarea } from '@/components/ui/textarea'
import { Switch } from '@/components/ui/switch'
import { Separator } from '@/components/ui/separator'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  AlertDialog,
  AlertDialogAction,
  AlertDialogCancel,
  AlertDialogContent,
  AlertDialogDescription,
  AlertDialogFooter,
  AlertDialogHeader,
  AlertDialogTitle,
  AlertDialogTrigger,
} from '@/components/ui/alert-dialog'
import { cn } from '@/lib/utils'
import { APP_NAME } from '@/lib/version'
import { useToast } from '@/hooks/use-toast'

interface SetupStep {
  id: string
  title: string
  description: string
  icon: React.ComponentType<{ className?: string }>
}

// 步骤1：Bot基础信息
interface BotBasicConfig {
  qq_account: number
  nickname: string
  alias_names: string[]
}

// 步骤2：人格配置
interface PersonalityConfig {
  personality: string
  reply_style: string
  interest: string
  plan_style: string
  private_plan_style: string
}

// 步骤3：表情包配置
interface EmojiConfig {
  emoji_chance: number
  max_reg_num: number
  do_replace: boolean
  check_interval: number
  steal_emoji: boolean
  content_filtration: boolean
  filtration_prompt: string
}

// 步骤4：其他基础配置
interface OtherBasicConfig {
  enable_tool: boolean
  enable_mood: boolean
  mood_update_threshold: number
  emotion_style: string
  all_global: boolean
}

// 步骤5：模型配置
interface ModelBasicConfig {
  api_provider_name: string
  api_provider_base_url: string
  api_provider_api_key: string
  replyer_model: string
  planner_model: string
  utils_model: string
}

export function SetupPage() {
  const navigate = useNavigate()
  const { toast } = useToast()
  const [currentStep, setCurrentStep] = useState(0)
  const [isCompleting, setIsCompleting] = useState(false)
  const [isSaving, setIsSaving] = useState(false)

  // 步骤1：Bot基础信息
  const [botBasic, setBotBasic] = useState<BotBasicConfig>({
    qq_account: 0,
    nickname: '',
    alias_names: [],
  })
  const [aliasInput, setAliasInput] = useState('')

  // 步骤2：人格配置
  const [personality, setPersonality] = useState<PersonalityConfig>({
    personality: '',
    reply_style: '',
    interest: '',
    plan_style: '',
    private_plan_style: '',
  })

  // 步骤3：表情包配置
  const [emoji, setEmoji] = useState<EmojiConfig>({
    emoji_chance: 0.4,
    max_reg_num: 40,
    do_replace: true,
    check_interval: 10,
    steal_emoji: true,
    content_filtration: false,
    filtration_prompt: '',
  })

  // 步骤4：其他基础配置
  const [otherBasic, setOtherBasic] = useState<OtherBasicConfig>({
    enable_tool: true,
    enable_mood: false,
    mood_update_threshold: 1,
    emotion_style: '',
    all_global: true,
  })

  // 步骤5：模型配置
  const [modelBasic, setModelBasic] = useState<ModelBasicConfig>({
    api_provider_name: '',
    api_provider_base_url: '',
    api_provider_api_key: '',
    replyer_model: '',
    planner_model: '',
    utils_model: '',
  })

  const steps: SetupStep[] = [
    {
      id: 'bot-basic',
      title: 'Bot基础',
      description: '配置机器人的基本信息',
      icon: Bot,
    },
    {
      id: 'personality',
      title: '人格配置',
      description: '定义机器人的性格和说话风格',
      icon: User,
    },
    {
      id: 'emoji',
      title: '表情包',
      description: '配置表情包相关设置',
      icon: Smile,
    },
    {
      id: 'other',
      title: '其他设置',
      description: '工具、情绪系统等配置',
      icon: Settings,
    },
    {
      id: 'model',
      title: '模型配置',
      description: '配置AI模型提供商',
      icon: Zap,
    },
  ]

  const progress = ((currentStep + 1) / steps.length) * 100

  const handleNext = () => {
    if (currentStep < steps.length - 1) {
      setCurrentStep(currentStep + 1)
    }
  }

  const handlePrevious = () => {
    if (currentStep > 0) {
      setCurrentStep(currentStep - 1)
    }
  }

  const handleComplete = async () => {
    setIsCompleting(true)

    try {
      const token = localStorage.getItem('access-token')

      const response = await fetch('/api/webui/setup/complete', {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })

      const data = await response.json()

      if (response.ok && data.success) {
        navigate({ to: '/' })
      } else {
        console.error('标记配置完成失败:', data.message)
      }
    } catch (error) {
      console.error('标记配置完成错误:', error)
    } finally {
      setIsCompleting(false)
    }
  }

  const handleSkip = async () => {
    await handleComplete()
  }

  return (
    <div className="relative flex min-h-screen flex-col items-center justify-center overflow-hidden bg-gradient-to-br from-primary/5 via-background to-secondary/5 p-4 md:p-6">
      {/* 背景装饰 */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute left-1/4 top-1/4 h-64 w-64 md:h-96 md:w-96 rounded-full bg-primary/5 blur-3xl" />
        <div className="absolute right-1/4 bottom-1/4 h-64 w-64 md:h-96 md:w-96 rounded-full bg-secondary/5 blur-3xl" />
      </div>

      {/* 主要内容 */}
      <div className="relative z-10 w-full max-w-4xl">
        {/* 头部 */}
        <div className="mb-6 md:mb-8 text-center">
          <div className="mx-auto mb-4 flex h-12 w-12 md:h-16 md:w-16 items-center justify-center rounded-2xl bg-primary/10">
            <Sparkles className="h-6 w-6 md:h-8 md:w-8 text-primary" strokeWidth={2} fill="none" />
          </div>
          <h1 className="mb-2 text-2xl md:text-3xl font-bold">首次配置向导</h1>
          <p className="text-sm md:text-base text-muted-foreground">
            让我们一起完成 {APP_NAME} 的初始配置
          </p>
        </div>

        {/* 进度条 */}
        <div className="mb-6 md:mb-8">
          <div className="mb-2 flex items-center justify-between text-xs md:text-sm">
            <span className="text-muted-foreground">
              步骤 {currentStep + 1} / {steps.length}
            </span>
            <span className="font-medium text-primary">{Math.round(progress)}%</span>
          </div>
          <Progress value={progress} className="h-2" />
        </div>

        {/* 步骤指示器 - 移动端优化 */}
        <div className="mb-6 md:mb-8 flex justify-between">
          {steps.map((step, index) => (
            <div
              key={step.id}
              className={cn(
                'flex flex-1 flex-col items-center gap-1 md:gap-2',
                index < steps.length - 1 && 'relative'
              )}
            >
              {/* 连接线 */}
              {index < steps.length - 1 && (
                <div
                  className={cn(
                    'absolute left-1/2 top-3 md:top-4 h-0.5 w-full',
                    index < currentStep ? 'bg-primary' : 'bg-border'
                  )}
                />
              )}

              {/* 步骤圆圈 */}
              <div
                className={cn(
                  'relative z-10 flex h-6 w-6 md:h-8 md:w-8 items-center justify-center rounded-full border-2 transition-all',
                  index === currentStep
                    ? 'border-primary bg-primary text-primary-foreground'
                    : index < currentStep
                      ? 'border-primary bg-primary text-primary-foreground'
                      : 'border-border bg-background text-muted-foreground'
                )}
              >
                {index < currentStep ? (
                  <CheckCircle2 className="h-3 w-3 md:h-4 md:w-4" strokeWidth={2.5} fill="none" />
                ) : (
                  <span className="text-xs md:text-sm font-medium">{index + 1}</span>
                )}
              </div>

              {/* 步骤标题 - 移动端隐藏部分文字 */}
              <span
                className={cn(
                  'text-[10px] md:text-xs text-center max-w-[60px] md:max-w-none truncate md:whitespace-normal',
                  index === currentStep ? 'font-medium text-foreground' : 'text-muted-foreground'
                )}
                title={step.title}
              >
                {step.title}
              </span>
            </div>
          ))}
        </div>

        {/* 步骤内容卡片 */}
        <Card className="mb-6 md:mb-8 shadow-lg">
          <CardContent className="p-4 md:p-8">
            <div className="min-h-[200px] md:min-h-[300px]">
              <h2 className="mb-3 md:mb-4 text-xl md:text-2xl font-semibold">{steps[currentStep].title}</h2>
              <p className="mb-4 md:mb-6 text-sm md:text-base text-muted-foreground">{steps[currentStep].description}</p>

              {/* 这里将来会根据不同步骤显示不同的配置表单 */}
              <div className="rounded-lg border bg-muted/50 p-4 md:p-6 text-center">
                <p className="text-xs md:text-sm text-muted-foreground">
                  配置内容即将添加...
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        {/* 操作按钮 */}
        <div className="flex flex-col sm:flex-row items-center justify-between gap-3 sm:gap-0">
          <Button
            variant="outline"
            onClick={handlePrevious}
            disabled={currentStep === 0}
            className="w-full sm:w-auto order-2 sm:order-1"
          >
            上一步
          </Button>

          <div className="flex gap-2 w-full sm:w-auto order-1 sm:order-2">
            <AlertDialog>
              <AlertDialogTrigger asChild>
                <Button variant="ghost" className="flex-1 sm:flex-none gap-2">
                  <SkipForward className="h-4 w-4" strokeWidth={2} fill="none" />
                  跳过向导
                </Button>
              </AlertDialogTrigger>
              <AlertDialogContent>
                <AlertDialogHeader>
                  <AlertDialogTitle>确认跳过配置向导</AlertDialogTitle>
                  <AlertDialogDescription>
                    您可以随时在系统设置中重新进入配置向导。确定要跳过吗？
                  </AlertDialogDescription>
                </AlertDialogHeader>
                <AlertDialogFooter>
                  <AlertDialogCancel>取消</AlertDialogCancel>
                  <AlertDialogAction onClick={handleSkip}>
                    确认跳过
                  </AlertDialogAction>
                </AlertDialogFooter>
              </AlertDialogContent>
            </AlertDialog>

            {currentStep === steps.length - 1 ? (
              <Button onClick={handleComplete} disabled={isCompleting} className="flex-1 sm:flex-none">
                {isCompleting ? (
                  <>
                    <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
                    完成中...
                  </>
                ) : (
                  <>
                    完成配置
                    <CheckCircle2 className="ml-2 h-4 w-4" strokeWidth={2} fill="none" />
                  </>
                )}
              </Button>
            ) : (
              <Button onClick={handleNext} className="flex-1 sm:flex-none">
                下一步
                <ArrowRight className="ml-2 h-4 w-4" strokeWidth={2} fill="none" />
              </Button>
            )}
          </div>
        </div>
      </div>

      {/* 页脚提示 */}
      <div className="relative z-10 mt-6 md:mt-8 text-center text-xs text-muted-foreground">
        <p>您可以随时在设置中修改这些配置</p>
      </div>
    </div>
  )
}
